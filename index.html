<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Essay Grader</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    input[type="text"] {
      width: 100%;
    }
    #rubric-table input {
      width: 90%;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>Essay Grader</h2>
<label>Grade Level: <input type="text" id="grade-level"></label>
<label>Class/Subject: <input type="text" id="class-subject"></label>

<h3>Rubric</h3>
<table id="rubric-table">
  <thead>
    <tr>
      <th>Final Grade</th>
      <th><input type="text" value="Criterion 1" class="criterion-name"></th>
    </tr>
  </thead>
  <tbody>
    <tr class="weight-row">
      <td><strong>Weight (% or points)</strong></td>
      <td><input type="text" class="weight-input"></td>
    </tr>
    <tr>
      <td><input type="text" value="Excellent" class="level-name"></td>
      <td><input type="text"></td>
    </tr>
    <tr>
      <td><input type="text" value="Good" class="level-name"></td>
      <td><input type="text"></td>
    </tr>
    <tr>
      <td><input type="text" value="Needs Improvement" class="level-name"></td>
      <td><input type="text"></td>
    </tr>
  </tbody>
</table>
<button id="add-criterion">Add Criterion</button>
<button id="remove-criterion">Remove Criterion</button>
<button id="add-rubric-row">Add Rubric Row</button>

<h3>Essays</h3>
<table id="essay-body">
  <thead>
    <tr>
      <th>Student Name</th>
      <th>Essay</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><input type="text"></td>
      <td><input type="text"></td>
    </tr>
  </tbody>
</table>
<button id="add-essay">Add Essay</button>
<button id="submit-btn">Submit</button>

<div id="output"></div>

<!-- Modal for grading essays -->
<div id="gradeModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Grade Essay</h3>
    <label for="student-name">Student Name:</label>
    <input type="text" id="student-name" disabled>
    
    <label for="overall-grade">Overall Grade:</label>
    <input type="text" id="overall-grade">
    
    <h4>Subgrades:</h4>
    <div id="subgrades-container"></div>
    
    <button id="grade-submit">Submit Grade</button>
  </div>
</div>

<script type="module">
  import Groq from "https://cdn.jsdelivr.net/npm/groq-sdk@0.8.0/+esm";

  const encodedApiKey = "Z3NrX21tTzZvWlpXMjdQbkJqTnpyWFVHV0dkeWIzRllsT0Z5TzVBYUtSbldQUGdubkZ5T1hKY2M=";
  const decodedApiKey = atob(encodedApiKey);
  const client = new Groq({ apiKey: decodedApiKey, dangerouslyAllowBrowser: true });

  const rubricTable = document.getElementById('rubric-table').querySelector('tbody');
  const addCriterionBtn = document.getElementById('add-criterion');
  const removeCriterionBtn = document.getElementById('remove-criterion');
  const addRubricRowBtn = document.getElementById('add-rubric-row');
  const addEssayBtn = document.getElementById('add-essay');
  const essayTable = document.getElementById('essay-body').querySelector('tbody');
  const gradeModal = document.getElementById("gradeModal");
  const studentNameInput = document.getElementById("student-name");
  const overallGradeInput = document.getElementById("overall-grade");
  const subgradesContainer = document.getElementById("subgrades-container");
  const closeModal = document.querySelector(".close");
  const gradeSubmit = document.getElementById("grade-submit");

  let selectedEssays = []; // Declare selectedEssays at the top-level

  addCriterionBtn.addEventListener('click', () => {
    const headRow = document.querySelector('#rubric-table thead tr');
    const newTh = document.createElement('th');
    const input = document.createElement('input');
    input.classList.add('criterion-name');
    input.type = 'text';
    input.value = `Criterion ${headRow.children.length}`;
    newTh.appendChild(input);
    headRow.appendChild(newTh);

    rubricTable.querySelectorAll('tr').forEach((row, i) => {
      const newTd = document.createElement('td');
      const textInput = document.createElement('input');
      textInput.type = 'text';
      newTd.appendChild(textInput);
      row.appendChild(newTd);
    });
  });

  removeCriterionBtn.addEventListener('click', () => {
    const headRow = document.querySelector('#rubric-table thead tr');
    const columnCount = headRow.children.length;
    for (let i = 1; i < columnCount; i++) {
      headRow.removeChild(headRow.lastElementChild);
      rubricTable.querySelectorAll('tr').forEach(row => {
        row.removeChild(row.lastElementChild);
      });
    }
  });

  addRubricRowBtn.addEventListener('click', () => {
    const row = document.createElement('tr');
    const tdLabel = document.createElement('td');
    const inputText = document.createElement('input');
    inputText.type = 'text'; // Allow renaming
    tdLabel.appendChild(inputText);
    row.appendChild(tdLabel);

    const columnCount = document.querySelector('#rubric-table thead tr').children.length;
    for (let i = 1; i < columnCount; i++) {
      const td = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'text';
      td.appendChild(input);
      row.appendChild(td);
    }
    rubricTable.appendChild(row);
  });

  addEssayBtn.addEventListener('click', () => {
    const row = document.createElement('tr');
    const nameCell = document.createElement('td');
    const essayCell = document.createElement('td');
    nameCell.innerHTML = `<input type="text">`;
    essayCell.innerHTML = `<input type="text">`;
    row.appendChild(nameCell);
    row.appendChild(essayCell);
    essayTable.appendChild(row);
  });

  function openGradeModal(selectedEssay) {
    const studentName = selectedEssay.children[0].querySelector('input').value;
    studentNameInput.value = studentName;

    subgradesContainer.innerHTML = '';
    const criteria = Array.from(document.querySelectorAll('.criterion-name'));
    
    criteria.forEach((criterion, index) => {
      const subgradeDiv = document.createElement('div');
      subgradeDiv.innerHTML = `<label>${criterion.value}</label>: <input type="text" class="subgrade-input" id="subgrade-${index}">`;
      subgradesContainer.appendChild(subgradeDiv);
    });
    
    gradeModal.style.display = "block";
  }

  closeModal.onclick = function() {
    gradeModal.style.display = "none";
  }

  gradeSubmit.addEventListener('click', async () => {
    const studentName = studentNameInput.value;
    const overallGrade = overallGradeInput.value;
    const subgrades = Array.from(subgradesContainer.querySelectorAll('.subgrade-input')).map(input => input.value);
    
    console.log(`Overall Grade for ${studentName}: ${overallGrade}`);
    subgrades.forEach((subgrade, index) => {
      console.log(`Subgrade ${index + 1} for ${studentName}: ${subgrade}`);
    });

    // Close the modal
    gradeModal.style.display = "none";

    // After closing the modal, check if we've graded 8 essays
    if (selectedEssays.length > 0) {
      const nextEssay = selectedEssays.shift(); // Pop the next essay from the list
      openGradeModal(nextEssay); // Open for the next essay
    } else {
      // All essays graded, log Groq grading results
      await gradeWithGroq();
    }
  });

  async function gradeWithGroq() {
    const gradeLevel = document.getElementById('grade-level').value;
    const subject = document.getElementById('class-subject').value;
    const rubricInput = document.getElementById('rubric-table').outerHTML;
    const criteria = Array.from(document.querySelectorAll('.criterion-name')).map(e => e.value);
    const essays = Array.from(document.querySelectorAll('#essay-body tbody tr'));

    for (const essay of essays) {
      const studentName = essay.children[0].querySelector('input').value;
      const essayText = essay.children[1].querySelector('input').value;

      let systemMessage = `You are an expert essay grader for grade ${gradeLevel} ${subject}. Here is the rubric: ${rubricInput}. Grade the following essay:`;
      let userMessage = `Essay by ${studentName}: ${essayText}. Use the following format:\n`;
      userMessage += `Overall Grade: {grade} + {feedback}\n`;
      criteria.forEach((criterion, index) => {
        userMessage += `Subgrade ${index + 1}: ${criterion} + {grade} + {feedback}\n`;
      });
      userMessage += `Conciseness + {grade} + {feedback}\nConventions + {grade} + {feedback}\nDetail + {grade} + {feedback}\nDescriptions + {grade} + {feedback}`;
      
      const params = {
        messages: [
          { role: "system", content: systemMessage },
          { role: "user", content: userMessage }
        ],
        model: "llama3-8b-8192"
      };

      // Get Groq's grading results
      try {
        const chatCompletion = await client.chat.completions.create(params);
        const messageContent = chatCompletion.choices[0].message.content;

        console.log("Feedback from Groq for", studentName, ":", messageContent);
        
        // Here we should extract Groq's grades from the message content
        const groqGrades = {}; // Define how to extract these grades
        // Assume the extracted grades are stored in groqGrades object
        logGradingDifferences(overallGrade, subgrades, groqGrades); // You need to implement this
      } catch (err) {
        console.error("Error getting feedback for", studentName, ":", err);
      }
    }
  }

  function logGradingDifferences(teacherGrade, teacherSubgrades, groqGrades) {
    // Assuming groqGrades holds the structure similar to { overall, subgrades: [] }
    console.log(`Differences for each essay:`);
    console.log(`Overall Grade Difference: ${teacherGrade - groqGrades.overall}`);
    teacherSubgrades.forEach((subgrade, index) => {
      console.log(`Subgrade ${index + 1} Difference: ${subgrade - groqGrades.subgrades[index]}`);
    });
  }

  document.getElementById('submit-btn').addEventListener('click', async function () {
    const essays = Array.from(document.querySelectorAll('#essay-body tbody tr'));
    if (essays.length < 8) {
      alert('Please add at least 8 essays before submitting.');
      return;
    }

    selectedEssays = [...essays]; // Assign to the global selectedEssays array
    openGradeModal(selectedEssays.shift()); // Open for the first selected essay
  });
</script>
</body>
</html>
