<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Essay Grader</title>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    input[type="text"] {
      width: 100%;
    }
    #rubric-table input {
      width: 90%;
    }
  </style>
</head>
<body>

<h2>Essay Grader</h2>
<label>Grade Level: <input type="text" id="grade-level"></label>
<label>Class/Subject: <input type="text" id="class-subject"></label>

<h3>Rubric</h3>
<table id="rubric-table">
  <thead>
    <tr>
      <th>Final Grade</th>
      <th><input type="text" value="Criterion 1" class="criterion-name"></th>
    </tr>
  </thead>
  <tbody>
    <tr class="weight-row">
      <td><strong>Weight (% or points)</strong></td>
      <td><input type="text" class="weight-input"></td>
    </tr>
    <tr>
      <td>Excellent</td>
      <td><input type="text"></td>
    </tr>
    <tr>
      <td>Good</td>
      <td><input type="text"></td>
    </tr>
    <tr>
      <td>Needs Improvement</td>
      <td><input type="text"></td>
    </tr>
  </tbody>
</table>
<button id="add-criterion">Add Criterion</button>
<button id="add-rubric-row">Add Rubric Row</button>

<h3>Essays</h3>
<table id="essay-body">
  <thead>
    <tr>
      <th>Student Name</th>
      <th>Essay</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><input type="text"></td>
      <td><input type="text"></td>
    </tr>
  </tbody>
</table>
<button id="add-essay">Add Essay</button>
<button id="submit-btn">Submit</button>

<div id="output"></div>

<script type="module">
  import Groq from "https://cdn.jsdelivr.net/npm/groq-sdk@0.8.0/+esm";

  const encodedApiKey = "Z3NrX21tTzZvWlpXMjdQbkJqTnpyWFVHV0dkeWIzRllsT0Z5TzVBYUtSbldQUGdubkZ5T1hKY2M=";
  const decodedApiKey = atob(encodedApiKey);
  const client = new Groq({ apiKey: decodedApiKey, dangerouslyAllowBrowser: true });

  const rubricTable = document.getElementById('rubric-table').querySelector('tbody');
  const addCriterionBtn = document.getElementById('add-criterion');
  const addRubricRowBtn = document.getElementById('add-rubric-row');
  const addEssayBtn = document.getElementById('add-essay');
  const essayTable = document.getElementById('essay-body').querySelector('tbody');

  addCriterionBtn.addEventListener('click', () => {
    const headRow = document.querySelector('#rubric-table thead tr');
    const newTh = document.createElement('th');
    const input = document.createElement('input');
    input.classList.add('criterion-name');
    input.type = 'text';
    input.value = `Criterion ${headRow.children.length}`;
    newTh.appendChild(input);
    headRow.appendChild(newTh);

    rubricTable.querySelectorAll('tr').forEach((row, i) => {
      const newTd = document.createElement('td');
      if (i === 0) {
        const weightInput = document.createElement('input');
        weightInput.classList.add('weight-input');
        weightInput.type = 'text';
        newTd.appendChild(weightInput);
      } else {
        const textInput = document.createElement('input');
        textInput.type = 'text';
        newTd.appendChild(textInput);
      }
      row.appendChild(newTd);
    });
  });

  addRubricRowBtn.addEventListener('click', () => {
    const row = document.createElement('tr');
    const tdLabel = document.createElement('td');
    tdLabel.textContent = `Level ${rubricTable.rows.length}`;
    row.appendChild(tdLabel);

    const columnCount = document.querySelector('#rubric-table thead tr').children.length;
    for (let i = 1; i < columnCount; i++) {
      const td = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'text';
      td.appendChild(input);
      row.appendChild(td);
    }
    rubricTable.appendChild(row);
  });

  addEssayBtn.addEventListener('click', () => {
    const row = document.createElement('tr');
    const nameCell = document.createElement('td');
    const essayCell = document.createElement('td');
    nameCell.innerHTML = `<input type="text">`;
    essayCell.innerHTML = `<input type="text">`;
    row.appendChild(nameCell);
    row.appendChild(essayCell);
    essayTable.appendChild(row);
  });

  document.getElementById('submit-btn').addEventListener('click', async function () {
    const gradeLevel = document.getElementById('grade-level').value;
    const subject = document.getElementById('class-subject').value;
    const rubricInput = document.getElementById('rubric-table').outerHTML;
    const criteria = Array.from(document.querySelectorAll('.criterion-name')).map(e => e.value);

    const essays = Array.from(document.querySelectorAll('#essay-body tbody tr'));
    if (essays.length < 15) {
      alert('Please add at least 15 essays before submitting.');
      return;
    }

    let selectedEssays = [];
    while (selectedEssays.length < 8) {
      let randomEssay = essays[Math.floor(Math.random() * essays.length)];
      if (!selectedEssays.includes(randomEssay)) {
        selectedEssays.push(randomEssay);
      }
    }

    const promptInput = prompt("Enter the writing prompt:");

    for (const essay of selectedEssays) {
      const studentName = essay.children[0].querySelector('input').value;
      const essayText = essay.children[1].querySelector('input').value;

      let systemMessage = `You are an expert essay grader for grade ${gradeLevel} ${subject}. Here is the rubric: ${rubricInput}. Grade the following essay:`;
      let userMessage = `Essay by ${studentName}: ${essayText}. Use the following format:\n`;
      userMessage += `Overall Grade: {grade} + {feedback}\n`;
      criteria.forEach((criterion, index) => {
        userMessage += `Subgrade ${index + 1}: ${criterion} + {grade} + {feedback}\n`;
      });
      userMessage += `Conciseness + {grade} + {feedback}\nConventions + {grade} + {feedback}\nDetail + {grade} + {feedback}\nDescriptions + {grade} + {feedback}`;
      userMessage += `\nPrompt: ${promptInput}`;

      const params = {
        messages: [
          { role: "system", content: systemMessage },
          { role: "user", content: userMessage }
        ],
        model: "llama3-8b-8192"
      };

      try {
        const chatCompletion = await client.chat.completions.create(params);
        const messageContent = chatCompletion.choices[0].message.content;
        let formattedFeedback = messageContent.replace(/\n\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        const formattedFeedbackFinal = formattedFeedback.trim().split("\n").map(line => line.trim() + "<br>").join("");
        document.getElementById("output").innerHTML += `<h3>${studentName}'s Feedback:</h3>${formattedFeedbackFinal}<hr>`;
        console.log("Feedback for", studentName, ":", messageContent);
      } catch (err) {
        console.error("Error getting feedback for", studentName, ":", err);
      }
    }
  });
</script>
</body>
</html>
